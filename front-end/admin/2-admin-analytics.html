<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Analytics</title>
<link rel="stylesheet" href="admin.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .analytics-container {
        width: 92%;
        max-width: 1200px;
        margin: 20px auto;
    }

    .chart-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border-radius: 18px;
        padding: 28px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        margin-bottom: 24px;
    }

    .chart-card h2 {
        color: var(--blue);
        margin-bottom: 8px;
        font-size: 20px;
    }

    .chart-card p {
        color: #666;
        font-size: 14px;
        margin-bottom: 20px;
    }

    .chart-wrapper {
        position: relative;
        height: 350px;
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border-radius: 14px;
        padding: 24px;
        text-align: center;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--gold);
    }

    .stat-card .value {
        font-size: 36px;
        font-weight: 700;
        color: var(--blue);
        display: block;
    }

    .stat-card .label {
        font-size: 13px;
        color: #666;
        margin-top: 4px;
    }

    .teacher-select-row {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 16px;
    }

    .teacher-select-row select {
        padding: 10px 16px;
        border-radius: 10px;
        border: 1px solid #ddd;
        font-size: 14px;
        font-family: inherit;
        background: white;
        color: #1a1a1a;
        cursor: pointer;
        min-width: 200px;
    }

    .teacher-select-row label {
        font-weight: 600;
        color: rgba(255,255,255,0.9);
    }

    .legend-info {
        display: flex;
        gap: 24px;
        margin-top: 16px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #555;
    }

    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
    }

    .last-updated {
        text-align: center;
        font-size: 12px;
        color: rgba(255,255,255,0.6);
        margin-top: 20px;
    }
</style>
</head>
<body>

    <nav class="top-nav">
        <div class="nav-left">
          <img src="https://www.leanderisd.org/wp-content/uploads/2025/05/LEANDERâœµISD-Duotone-Blue-With-Tagline.png"
               class="lisd-logo">
        </div>
      
        <div class="nav-right">
          <a href="1-index.html" class="nav-link">Home</a>
          <a href="2-admin-analytics.html" class="nav-link">Analytics</a>
          <a href="3-admin-feedback.html" class="nav-link">Feedback Dashboard</a>
      
          <div class="profile-dropdown">
            <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png"
                 class="nav-icon" id="profileBtn">
            <div class="dropdown-menu hide" id="profileMenu">
              <h3>Admin Settings</h3>
              <button class="dropdown-item" id="themeToggle">Toggle Light/Dark Mode</button>
              <button class="dropdown-item" onclick="window.location.href='settings.html'">Settings</button>
              <button class="dropdown-item" onclick="sessionStorage.clear(); window.location.href='/'">Logout</button>
            </div>
          </div>
        </div>
      </nav>

<header class="app-header">
    <h1>Analytics Dashboard</h1>
</header>

<div class="analytics-container">
    <!-- Summary Stats -->
    <div class="stats-row">
        <div class="stat-card">
            <span class="value" id="totalFeedback">0</span>
            <span class="label">Total Feedback</span>
        </div>
        <div class="stat-card">
            <span class="value" id="totalTeachers">0</span>
            <span class="label">Teachers</span>
        </div>
        <div class="stat-card">
            <span class="value" id="avgRatio">0%</span>
            <span class="label">Avg. Positive-Only Rate</span>
        </div>
        <div class="stat-card">
            <span class="value" id="lastPeriod">--</span>
            <span class="label">Current Period</span>
        </div>
    </div>

    <!-- Main Chart -->
    <div class="chart-card">
        <h2>Teacher Performance Over School Year</h2>
        <p>Positive-only feedback ratio by period (higher is better)</p>
        
        <div class="teacher-select-row">
            <label for="teacherFilter">Filter by Teacher:</label>
            <select id="teacherFilter">
                <option value="all">All Teachers</option>
            </select>
        </div>

        <div class="chart-wrapper">
            <canvas id="analyticsChart"></canvas>
        </div>

        <div class="legend-info">
            <div class="legend-item">
                <div class="legend-color" style="background: #0033A0;"></div>
                <span>Positive-Only Rate (%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFB81C;"></div>
                <span>Total Feedback Count</span>
            </div>
        </div>
    </div>

    <!-- Per-Teacher Breakdown -->
    <div class="chart-card">
        <h2>Teacher Comparison</h2>
        <p>Compare performance across all teachers</p>
        <div class="chart-wrapper">
            <canvas id="comparisonChart"></canvas>
        </div>
    </div>

    <p class="last-updated" id="lastUpdated">Last updated: --</p>
</div>

<script src="admin.js"></script>
<script>
    let analyticsChart = null;
    let comparisonChart = null;
    const periods = ['Aug-Sep', 'Oct-Nov', 'Dec-Jan', 'Feb-Mar', 'Apr-May', 'Jun-Jul'];
    const colors = ['#0033A0', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];

    // Determine current period
    function getCurrentPeriod() {
        const month = new Date().getMonth();
        if ([7, 8].includes(month)) return 'Aug-Sep';
        if ([9, 10].includes(month)) return 'Oct-Nov';
        if ([11, 0].includes(month)) return 'Dec-Jan';
        if ([1, 2].includes(month)) return 'Feb-Mar';
        if ([3, 4].includes(month)) return 'Apr-May';
        return 'Jun-Jul';
    }

    async function loadAnalytics() {
        try {
            const res = await fetch('http://localhost:3000/feedback/analytics');
            const data = await res.json();

            // Update stats
            document.getElementById('totalFeedback').textContent = data.totalFeedback;
            document.getElementById('totalTeachers').textContent = data.teachers.length;
            document.getElementById('lastPeriod').textContent = getCurrentPeriod();

            // Calculate average ratio
            let totalRatio = 0;
            let count = 0;
            Object.values(data.analytics).forEach(periods => {
                periods.forEach(p => {
                    if (p.total > 0) {
                        totalRatio += parseFloat(p.ratio);
                        count++;
                    }
                });
            });
            document.getElementById('avgRatio').textContent = count > 0 ? Math.round(totalRatio / count) + '%' : '0%';

            // Update teacher filter
            const teacherFilter = document.getElementById('teacherFilter');
            const currentValue = teacherFilter.value;
            teacherFilter.innerHTML = '<option value="all">All Teachers</option>';
            data.teachers.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                teacherFilter.appendChild(opt);
            });
            teacherFilter.value = currentValue || 'all';

            // Build chart data
            updateCharts(data, teacherFilter.value);

            document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        } catch (err) {
            console.error('Failed to load analytics:', err);
        }
    }

    function updateCharts(data, selectedTeacher) {
        // Main line chart
        const ctx = document.getElementById('analyticsChart').getContext('2d');
        
        const datasets = [];
        const teachersToShow = selectedTeacher === 'all' ? data.teachers : [selectedTeacher];

        teachersToShow.forEach((teacher, index) => {
            const teacherData = data.analytics[teacher] || [];
            datasets.push({
                label: teacher,
                data: periods.map(p => {
                    const period = teacherData.find(pd => pd.period === p);
                    return period ? parseFloat(period.ratio) : 0;
                }),
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '20',
                fill: true,
                tension: 0.4,
                pointRadius: 6,
                pointHoverRadius: 8
            });
        });

        if (analyticsChart) analyticsChart.destroy();
        
        analyticsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: periods,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${context.raw}% positive-only`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Positive-Only Rate (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'School Year Period'
                        }
                    }
                }
            }
        });

        // Comparison bar chart
        const ctx2 = document.getElementById('comparisonChart').getContext('2d');
        
        const comparisonData = data.teachers.map(teacher => {
            const teacherData = data.analytics[teacher] || [];
            const totals = teacherData.reduce((acc, p) => acc + p.total, 0);
            const positiveOnly = teacherData.reduce((acc, p) => acc + p.positiveOnly, 0);
            return {
                teacher,
                total: totals,
                ratio: totals > 0 ? Math.round((positiveOnly / totals) * 100) : 0
            };
        });

        if (comparisonChart) comparisonChart.destroy();

        comparisonChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: comparisonData.map(d => d.teacher),
                datasets: [
                    {
                        label: 'Total Feedback',
                        data: comparisonData.map(d => d.total),
                        backgroundColor: '#FFB81C',
                        yAxisID: 'y1'
                    },
                    {
                        label: 'Positive-Only Rate (%)',
                        data: comparisonData.map(d => d.ratio),
                        backgroundColor: '#0033A0',
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Positive-Only Rate (%)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Total Feedback'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }

    // Filter change
    document.getElementById('teacherFilter').addEventListener('change', async () => {
        const res = await fetch('http://localhost:3000/feedback/analytics');
        const data = await res.json();
        updateCharts(data, document.getElementById('teacherFilter').value);
    });

    // Initial load
    loadAnalytics();

    // Auto-refresh every 15 seconds
    setInterval(loadAnalytics, 15000);
</script>

</body>
</html>
