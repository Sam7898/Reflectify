<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Settings - Student</title>
<link rel="stylesheet" href="student.css">
<style>
    .settings-card {
        background: var(--card);
        border-radius: 16px;
        padding: 32px;
        box-shadow: var(--shadow);
        border-left: 5px solid var(--gold);
        max-width: 500px;
        margin: 0 auto;
    }
    .settings-card h2 { color: var(--blue); margin-bottom: 24px; font-size: 22px; }
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; color: #555; font-size: 13px; font-weight: 600; margin-bottom: 6px; }
    .form-group input {
        width: 100%;
        padding: 12px 14px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 10px;
        color: #1a1a1a;
        font-size: 14px;
        font-family: inherit;
        transition: 0.25s ease;
    }
    .form-group input:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(0,51,160,0.1); background: white; }
    .submit-btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, var(--blue), var(--blue-dark));
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.25s ease;
        margin-top: 8px;
    }
    .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,51,160,0.3); }
    .message { padding: 12px 16px; border-radius: 8px; font-size: 14px; margin-bottom: 16px; display: none; }
    .success-message { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #16a34a; }
    .error-message { background: rgba(229, 57, 53, 0.1); border: 1px solid rgba(229, 57, 53, 0.3); color: #e53935; }
</style>
</head>
<body>

<nav class="top-nav">
    <div class="nav-left">
        <img src="https://www.leanderisd.org/wp-content/uploads/2025/05/LEANDERâœµISD-Duotone-Blue-With-Tagline.png" alt="Leander ISD Logo" class="lisd-logo">
    </div>
    <div class="nav-right">
        <a href="student.html" class="nav-link">Home</a>
        <a href="student.html#submitted" class="nav-link">Submitted Feedback</a>
        <div class="profile-dropdown">
            <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="nav-icon" id="profileBtn">
            <div class="dropdown-menu hide" id="profileMenu">
                <h3>Student Settings</h3>
                <button class="dropdown-item" id="themeToggle">Toggle Light/Dark Mode</button>
                <button class="dropdown-item" onclick="window.location.href='settings.html'">Settings</button>
                <button class="dropdown-item" onclick="sessionStorage.clear(); window.location.href='/'">Logout</button>
            </div>
        </div>
    </div>
</nav>

<header class="app-header">
    <h1>Settings</h1>
</header>

<div class="container">
    <div class="settings-card">
        <h2>Edit Profile</h2>
        
        <div class="message success-message" id="successMsg"></div>
        <div class="message error-message" id="errorMsg"></div>

        <form id="profileForm">
            <div class="form-group">
                <label for="settingsName">Full Name</label>
                <input type="text" id="settingsName" placeholder="Your full name" required>
            </div>
            <div class="form-group">
                <label for="settingsUsername">Username</label>
                <input type="text" id="settingsUsername" placeholder="Your username" required minlength="3">
            </div>
            <div class="form-group">
                <label for="settingsPassword">New Password (leave blank to keep current)</label>
                <input type="password" id="settingsPassword" placeholder="Enter new password" minlength="6">
            </div>
            <button type="submit" class="submit-btn">Save Changes</button>
        </form>
    </div>
</div>

<script>
    // Theme
    let darkMode = localStorage.getItem('studentDarkMode') !== 'false';
    if (!darkMode) document.body.classList.add('light-mode');
    
    document.getElementById('themeToggle')?.addEventListener('click', () => {
        darkMode = !darkMode;
        document.body.classList.toggle('light-mode', !darkMode);
        localStorage.setItem('studentDarkMode', darkMode);
    });

    // Dropdown
    const profileBtn = document.getElementById('profileBtn');
    const profileMenu = document.getElementById('profileMenu');
    profileBtn?.addEventListener('click', (e) => { e.stopPropagation(); profileMenu.classList.toggle('show'); profileMenu.classList.toggle('hide'); });
    document.addEventListener('click', () => { profileMenu?.classList.remove('show'); profileMenu?.classList.add('hide'); });

    // Load user data
    document.addEventListener('DOMContentLoaded', () => {
        const user = JSON.parse(sessionStorage.getItem('user'));
        if (user) {
            document.getElementById('settingsName').value = user.name || '';
            document.getElementById('settingsUsername').value = user.username || '';
        }
    });

    // Save profile
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = JSON.parse(sessionStorage.getItem('user'));
        const name = document.getElementById('settingsName').value.trim();
        const newUsername = document.getElementById('settingsUsername').value.trim();
        const newPassword = document.getElementById('settingsPassword').value;

        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.style.display = 'none';
        successMsg.style.display = 'none';

        try {
            const response = await fetch('/api/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    currentUsername: user.username,
                    name,
                    newUsername: newUsername !== user.username ? newUsername : undefined,
                    newPassword: newPassword || undefined
                })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.message);

            user.name = data.name;
            user.username = data.username;
            sessionStorage.setItem('user', JSON.stringify(user));

            successMsg.textContent = 'Profile updated successfully!';
            successMsg.style.display = 'block';
            document.getElementById('settingsPassword').value = '';
        } catch (err) {
            errorMsg.textContent = err.message;
            errorMsg.style.display = 'block';
        }
    });
</script>
</body>
</html>

